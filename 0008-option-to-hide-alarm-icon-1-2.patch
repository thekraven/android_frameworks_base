From b881489209c9cceb98302f855a9645d7c125d93f Mon Sep 17 00:00:00 2001
From: Konsta <konsta09@gmail.com>
Date: Thu, 5 Jul 2012 11:31:15 +0300
Subject: [PATCH 16/16] option to hide alarm icon (1/2)

Change-Id: I29743173497baf1ca1d26b2af59d6ebe1534080e
---
 core/java/android/provider/Settings.java           |   10 ++++-
 .../statusbar/phone/PhoneStatusBarPolicy.java      |   40 +++++++++++++++++++-
 2 files changed, 47 insertions(+), 3 deletions(-)

diff --git a/core/java/android/provider/Settings.java b/core/java/android/provider/Settings.java
index 54f18a6..8dcc141 100644
--- a/core/java/android/provider/Settings.java
+++ b/core/java/android/provider/Settings.java
@@ -2411,9 +2411,17 @@ public final class Settings {
          * Whether to place the status bar at the bottom of the screen
          * @hide
          */
-
         public static final String STATUS_BAR_BOTTOM = "status_bar_bottom";
 
+         /** Whether to show the alarm icon in status bar
+         * of the stock clock
+         * 0: don't show the alarm icon
+         * 1: show the alarm icon
+         * default: 1
+         * @hide
+         */
+        public static final String STATUS_BAR_ALARM = "status_bar_alarm";
+
         /**
          * Whether to use a separate delay for "slide to unlock" and security
          * lock
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/phone/PhoneStatusBarPolicy.java b/packages/SystemUI/src/com/android/systemui/statusbar/phone/PhoneStatusBarPolicy.java
index 5f18b5d..b0f24dc 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/phone/PhoneStatusBarPolicy.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/phone/PhoneStatusBarPolicy.java
@@ -19,9 +19,11 @@ package com.android.systemui.statusbar.phone;
 import android.app.StatusBarManager;
 import android.bluetooth.BluetoothAdapter;
 import android.content.BroadcastReceiver;
+import android.content.ContentResolver;
 import android.content.Context;
 import android.content.Intent;
 import android.content.IntentFilter;
+import android.database.ContentObserver;
 import android.location.LocationManager;
 import android.media.AudioManager;
 import android.net.ConnectivityManager;
@@ -81,6 +83,10 @@ public class PhoneStatusBarPolicy {
     // ringer volume
     private boolean mVolumeVisible;
 
+    //alarm
+    private boolean mAlarmSet = false;
+    private boolean mShowAlarmIcon;
+
     // bluetooth device status
     private boolean mBluetoothEnabled = false;
 
@@ -135,10 +141,30 @@ public class PhoneStatusBarPolicy {
         }
     };
 
+    class SettingsObserver extends ContentObserver {
+        SettingsObserver(Handler handler) {
+            super(handler);
+        }
+
+        void observe() {
+            ContentResolver resolver = mContext.getContentResolver();
+            resolver.registerContentObserver(Settings.System
+                    .getUriFor(Settings.System.STATUS_BAR_ALARM), false, this);
+        }
+
+        @Override public void onChange(boolean selfChange) {
+            updateSettings();
+        }
+    }
+
     public PhoneStatusBarPolicy(Context context) {
         mContext = context;
         mService = (StatusBarManager)context.getSystemService(Context.STATUS_BAR_SERVICE);
 
+        SettingsObserver settingsObserver = new SettingsObserver(mHandler);
+        settingsObserver.observe();
+        updateSettings();
+
         // listen for broadcasts
         IntentFilter filter = new IntentFilter();
         filter.addAction(Intent.ACTION_ALARM_CHANGED);
@@ -193,8 +219,10 @@ public class PhoneStatusBarPolicy {
     }
 
     private final void updateAlarm(Intent intent) {
-        boolean alarmSet = intent.getBooleanExtra("alarmSet", false);
-        mService.setIconVisibility("alarm_clock", alarmSet);
+        boolean mAlarmSet = intent.getBooleanExtra("alarmSet", false);
+        mShowAlarmIcon = (Settings.System.getInt(mContext.getContentResolver(),
+                Settings.System.STATUS_BAR_ALARM, 1) == 1);
+        mService.setIconVisibility("alarm_clock", mAlarmSet && mShowAlarmIcon);
     }
 
     private final void updateSyncState(Intent intent) {
@@ -298,4 +326,12 @@ public class PhoneStatusBarPolicy {
             mService.setIconVisibility("tty", false);
         }
     }
+
+    private void updateSettings() {
+        ContentResolver resolver = mContext.getContentResolver();
+
+        mShowAlarmIcon = (Settings.System.getInt(resolver,
+                Settings.System.STATUS_BAR_ALARM, 1) == 1);
+        mService.setIconVisibility("alarm_clock", mAlarmSet && mShowAlarmIcon);
+    }
 }
-- 
1.7.9.5

